<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload - Gerenciador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-md mb-8">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <i class="fas fa-box text-blue-600 text-2xl"></i>
                <h1 class="text-2xl font-bold text-gray-800">Gerenciador de Produtos</h1>
            </div>
            <div class="flex space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-blue-600">Dashboard</a>
                <a href="products.html" class="text-gray-600 hover:text-blue-600">Produtos</a>
                <a href="upload-simple.html" class="text-blue-600 font-semibold">Upload</a>
                <a href="categories.html" class="text-gray-600 hover:text-blue-600">Categorias</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 max-w-4xl">
        <div class="mb-6">
            <h2 class="text-3xl font-bold text-gray-900">Upload de Produtos</h2>
            <p class="text-gray-600 mt-1">Selecione a categoria e faça upload do ZIP</p>
        </div>

        <!-- Nome da Categoria -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-folder mr-2"></i>
                Nome da Categoria *
            </label>
            <input 
                type="text" 
                id="categoryName" 
                placeholder="Digite o nome da categoria (ex: Eletrônicos, Roupas, Móveis...)"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
            >
            <p class="text-sm text-green-600 mt-2">
                <i class="fas fa-magic mr-1"></i>
                Se a categoria não existir, será criada automaticamente!
            </p>
        </div>

        <!-- Estrutura Esperada -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-2 flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                Estrutura do ZIP
            </h3>
            <p class="text-blue-800 text-sm mb-2">O ZIP deve conter pastas com os produtos. Exemplo:</p>
            <div class="bg-white rounded p-3 font-mono text-xs text-gray-700">
                produtos.zip<br>
                ├── iMac_24_M1_novo/<br>
                │   ├── descricao.txt<br>
                │   ├── info.txt (opcional)<br>
                │   └── foto.jpg<br>
                ├── MacBook_Pro/<br>
                │   ├── descricao.txt<br>
                │   └── imagem.png<br>
            </div>
            <p class="text-blue-700 text-xs mt-2">
                <strong>descricao.txt:</strong> Nome na 1ª linha, descrição no meio, preço na última linha (opcional)<br>
                <strong>Imagens:</strong> Serão usadas como placeholder (sem upload externo)
            </p>
        </div>

        <!-- Dropzone -->
        <div id="dropzone" class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-blue-500 transition mb-6">
            <input type="file" id="fileInput" accept=".zip" class="hidden">
            <i class="fas fa-file-archive text-gray-400 text-6xl mb-4"></i>
            <p class="text-lg font-medium text-gray-900 mb-2">
                Arraste um arquivo ZIP ou clique para selecionar
            </p>
            <p class="text-gray-600">Tamanho máximo: 500MB • Formato: ZIP</p>
        </div>

        <!-- Progress -->
        <div id="progressSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-xl font-semibold mb-4">Processando...</h3>
            <div class="mb-4">
                <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-center text-gray-600 mt-2">0 de 0 produtos</p>
            </div>
        </div>

        <!-- Products List -->
        <div id="productsSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Produtos Processados</h3>
            <div id="productsList" class="space-y-2 max-h-96 overflow-y-auto"></div>
            <button id="saveBtn" class="mt-6 w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                <i class="fas fa-save mr-2"></i>
                Salvar Todos os Produtos
            </button>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let products = [];

        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');

        dropzone.addEventListener('click', () => fileInput.click());
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.zip')) {
                processFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        async function processFile(file) {
            const categoryName = document.getElementById('categoryName').value.trim();
            
            if (!categoryName) {
                showNotification('Por favor, digite o nome da categoria primeiro!', 'error');
                return;
            }

            products = [];
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('productsList').innerHTML = '';

            try {
                const zip = await JSZip.loadAsync(file);
                const folders = [];

                zip.forEach((path, zipEntry) => {
                    if (!zipEntry.dir && path.includes('/')) {
                        const folder = path.split('/')[0];
                        if (!folders.includes(folder)) {
                            folders.push(folder);
                        }
                    }
                });

                if (folders.length === 0) {
                    throw new Error('Nenhuma pasta encontrada no ZIP');
                }

                document.getElementById('progressText').textContent = `0 de ${folders.length} produtos`;

                for (let i = 0; i < folders.length; i++) {
                    const folder = folders[i];
                    const folderName = folder.replace(/_/g, ' ');

                    const descricaoFile = zip.file(folder + '/descricao.txt');
                    const infoFile = zip.file(folder + '/info.txt');

                    if (!descricaoFile) {
                        console.warn(`Pasta ${folder} não tem descricao.txt, pulando...`);
                        continue;
                    }

                    const descricao = await descricaoFile.async('text');
                    const info = infoFile ? await infoFile.async('text') : '';

                    // Contar imagens
                    let imageCount = 0;
                    zip.forEach((path, zipEntry) => {
                        if (path.startsWith(folder + '/') && /\.(jpg|jpeg|png|gif|webp)$/i.test(path) && !zipEntry.dir) {
                            imageCount++;
                        }
                    });

                    const productData = parseProductData(folderName, descricao, info);
                    productData.category = categoryName; // Nome da categoria (será criada se não existir)
                    productData.images = []; // Sem imagens por enquanto
                    
                    products.push(productData);

                    const priceText = productData.price && productData.price > 0 
                        ? `R$ ${productData.price.toFixed(2)}` 
                        : 'Sem preço';

                    document.getElementById('productsList').innerHTML += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                            <div>
                                <p class="font-medium">${productData.name}</p>
                                <p class="text-sm text-gray-600">${priceText} • ${imageCount} imagens</p>
                            </div>
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                    `;

                    const progress = ((i + 1) / folders.length) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressText').textContent = `${i + 1} de ${folders.length} produtos`;
                }

                document.getElementById('progressSection').classList.add('hidden');
                document.getElementById('productsSection').classList.remove('hidden');

            } catch (error) {
                showNotification('Erro ao processar ZIP: ' + error.message, 'error');
                document.getElementById('progressSection').classList.add('hidden');
            }
        }

        function parseProductData(folderName, descricao, info) {
            const lines = descricao.split('\n').map(l => l.trim()).filter(l => l);
            
            let name = folderName;
            let description = '';
            let price = null;

            if (lines.length > 0) {
                name = lines[0];
                
                if (lines.length > 1) {
                    const lastLine = lines[lines.length - 1];
                    const priceMatch = lastLine.match(/R?\$?\s*([\d.,]+)/);
                    
                    if (priceMatch) {
                        const priceStr = priceMatch[1].replace(/\./g, '').replace(',', '.');
                        price = parseFloat(priceStr);
                        description = lines.slice(1, -1).join('\n');
                    } else {
                        description = lines.slice(1).join('\n');
                    }
                }
            }

            if (info) {
                description += (description ? '\n\n' : '') + info;
            }

            return {
                name: name,
                description: description || 'Sem descrição',
                price: price,
                images: []
            };
        }

        document.getElementById('saveBtn').addEventListener('click', async () => {
            if (products.length === 0) {
                showNotification('Nenhum produto para salvar', 'warning');
                return;
            }

            try {
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('saveBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

                const response = await fetchAPI('/api/admin/products/bulk', {
                    method: 'POST',
                    body: JSON.stringify({ products })
                });

                showNotification(`${products.length} produtos salvos com sucesso!`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'products.html';
                }, 2000);

            } catch (error) {
                showNotification('Erro ao salvar produtos: ' + error.message, 'error');
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Todos os Produtos';
            }
        });
    </script>
</body>
</html>
