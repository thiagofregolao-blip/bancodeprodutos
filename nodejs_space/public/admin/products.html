<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos - Gerenciador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-md mb-8">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <i class="fas fa-box text-blue-600 text-2xl"></i>
                <h1 class="text-2xl font-bold text-gray-800">Gerenciador de Produtos</h1>
            </div>
            <div class="flex space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-blue-600">Dashboard</a>
                <a href="products.html" class="text-blue-600 font-semibold">Produtos</a>
                <a href="upload.html" class="text-gray-600 hover:text-blue-600">Upload</a>
                <a href="categories.html" class="text-gray-600 hover:text-blue-600">Categorias</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Produtos</h2>
                <p class="text-gray-600 mt-1">Gerencie seu banco de produtos</p>
            </div>
            <a href="upload.html" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">
                <i class="fas fa-plus mr-2"></i>Adicionar Produtos
            </a>
        </div>

        <!-- Search -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex items-center gap-4">
                <div class="flex-1 relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input 
                        type="text" 
                        id="searchInput"
                        placeholder="Buscar produtos..." 
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <button onclick="searchProducts()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                    <i class="fas fa-filter mr-2"></i>Buscar
                </button>
            </div>
        </div>

        <!-- Products Grid -->
        <div id="productsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Produtos serão carregados aqui -->
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex items-center justify-center gap-4 mt-8">
            <!-- Paginação será carregada aqui -->
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let currentPage = 1;
        const limit = 12;

        async function loadProducts(page = 1) {
            try {
                const response = await fetchAPI(`/api/products?page=${page}&limit=${limit}`);
                renderProducts(response.data);
                renderPagination(response.meta);
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                showNotification('Erro ao carregar produtos', 'error');
            }
        }

        async function searchProducts() {
            const query = document.getElementById('searchInput').value;
            if (!query.trim()) {
                loadProducts(1);
                return;
            }

            try {
                const response = await fetchAPI(`/api/products/search?q=${encodeURIComponent(query)}`);
                renderProducts(response.data);
                document.getElementById('pagination').innerHTML = '';
            } catch (error) {
                console.error('Erro na busca:', error);
                showNotification('Erro na busca', 'error');
            }
        }

        function renderProducts(products) {
            const grid = document.getElementById('productsGrid');
            
            if (!products || products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Nenhum produto encontrado.</div>';
                return;
            }

            grid.innerHTML = products.map(product => `
                <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition group relative">
                    <a href="product-detail.html?id=${product.id}" class="block">
                        ${product.images?.[0] 
                            ? `<img src="${product.images[0].url}" alt="${product.name}" class="w-full h-48 object-cover rounded-t-lg group-hover:scale-105 transition">`
                            : '<div class="w-full h-48 bg-gray-200 rounded-t-lg flex items-center justify-center"><span class="text-gray-400">Sem imagem</span></div>'
                        }
                        <div class="p-4">
                            <h3 class="font-semibold text-gray-900 mb-1 truncate">${product.name}</h3>
                            <p class="text-sm text-gray-600 mb-2">${product.category || 'Sem categoria'}</p>
                            <div class="flex items-center justify-between">
                                <p class="text-lg font-bold text-blue-600">${product.price ? 'R$ ' + parseFloat(product.price).toFixed(2) : 'Sem preço'}</p>
                                ${product.condition ? `<span class="text-xs text-gray-500 px-2 py-1 bg-gray-100 rounded">${product.condition}</span>` : ''}
                            </div>
                        </div>
                    </a>
                    <button 
                        onclick="deleteProduct(event, ${product.id}, '${product.name.replace(/'/g, "\\'")}')"
                        class="absolute top-2 right-2 p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition opacity-0 group-hover:opacity-100 shadow-lg"
                        title="Excluir produto"
                    >
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderPagination(meta) {
            if (!meta || meta.totalPages <= 1) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <button 
                    onclick="changePage(${meta.page - 1})" 
                    ${meta.page === 1 ? 'disabled' : ''}
                    class="bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed text-gray-800 font-semibold py-2 px-4 rounded-lg"
                >
                    Anterior
                </button>
                <span class="text-gray-600">Página ${meta.page} de ${meta.totalPages}</span>
                <button 
                    onclick="changePage(${meta.page + 1})" 
                    ${meta.page === meta.totalPages ? 'disabled' : ''}
                    class="bg-gray-200 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed text-gray-800 font-semibold py-2 px-4 rounded-lg"
                >
                    Próxima
                </button>
            `;
        }

        function changePage(page) {
            currentPage = page;
            loadProducts(page);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteProduct(event, id, name) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!confirm(`Tem certeza que deseja excluir o produto:\n\n"${name}"\n\nEsta ação não pode ser desfeita!`)) {
                return;
            }

            try {
                await fetchAPI(`/api/admin/products/${id}`, {
                    method: 'DELETE'
                });
                
                showNotification(`✅ Produto "${name}" excluído com sucesso!`, 'success');
                loadProducts(currentPage); // Recarregar lista
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                showNotification('❌ Erro ao excluir produto: ' + error.message, 'error');
            }
        }

        // Enter para buscar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchProducts();
            });
            loadProducts(1);
        });
    </script>
</body>
</html>
